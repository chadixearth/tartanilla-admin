{% extends 'base.html' %}
{% load static %}

{% block title %}Announcements{% endblock %}

{% block content %}
<div class="p-6">
    <div class="bg-white rounded-lg shadow-sm p-6">
        <div class="mb-6">
            <h2 class="text-2xl font-semibold text-gray-800">ðŸ“¢ Send Announcement</h2>
        </div>
        
        <form id="announcementForm" class="space-y-4">
            <div>
                <label for="type" class="block text-sm font-medium text-gray-700 mb-2">Announcement Type</label>
                <select id="type" required class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-primary-dark">
                    <option value="general">General</option>
                    <option value="emergency">Emergency</option>
                    <option value="maintenance">Maintenance</option>
                    <option value="update">System Update</option>
                    <option value="promotion">Promotion</option>
                </select>
            </div>
            
            <div>
                <label for="targetRoles" class="block text-sm font-medium text-gray-700 mb-2">Send To</label>
                <div class="space-y-2">
                    <label class="flex items-center">
                        <input type="checkbox" id="allRoles" class="mr-2" checked>
                        <span class="text-sm font-semibold">All Users</span>
                    </label>
                    <div id="roleOptions" class="ml-6 space-y-2">
                        <label class="flex items-center">
                            <input type="checkbox" name="roles" value="tourist" class="mr-2">
                            <span class="text-sm">Tourists Only</span>
                        </label>
                        <label class="flex items-center">
                            <input type="checkbox" name="roles" value="driver" class="mr-2">
                            <span class="text-sm">Drivers Only</span>
                        </label>
                        <label class="flex items-center">
                            <input type="checkbox" name="roles" value="owner" class="mr-2">
                            <span class="text-sm">Owners Only</span>
                        </label>
                    </div>
                </div>
            </div>
            
            <div>
                <label for="message" class="block text-sm font-medium text-gray-700 mb-2">Message</label>
                <textarea id="message" rows="4" required class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-primary-dark" placeholder="Enter your announcement message..."></textarea>
                <p class="text-sm text-gray-500 mt-1" id="targetInfo">This message will be sent to all drivers, owners, and tourists.</p>
            </div>
            
            <button type="submit" id="sendBtn" class="bg-primary-dark text-white px-6 py-2 rounded-md hover:bg-primary-medium transition-colors prevent-multiple-clicks" data-prevent-multiple>
                <span class="btn-text">
                    <i class="fas fa-paper-plane mr-2"></i>Send Announcement
                </span>
                <span class="btn-loading hidden">
                    <i class="fas fa-spinner fa-spin mr-2"></i>Sending...
                </span>
            </button>
        </form>
    </div>
</div>

{% csrf_token %}
<script>
// Handle role selection UI
document.getElementById('allRoles').addEventListener('change', function() {
    const roleCheckboxes = document.querySelectorAll('input[name="roles"]');
    const targetInfo = document.getElementById('targetInfo');
    
    if (this.checked) {
        roleCheckboxes.forEach(cb => cb.checked = false);
        targetInfo.textContent = 'This message will be sent to all drivers, owners, and tourists.';
    } else {
        targetInfo.textContent = 'Select specific user types to send to.';
    }
});

// Update target info when specific roles are selected
document.querySelectorAll('input[name="roles"]').forEach(checkbox => {
    checkbox.addEventListener('change', function() {
        const allRoles = document.getElementById('allRoles');
        const selectedRoles = Array.from(document.querySelectorAll('input[name="roles"]:checked')).map(cb => cb.value);
        const targetInfo = document.getElementById('targetInfo');
        
        if (this.checked) {
            allRoles.checked = false;
        }
        
        if (selectedRoles.length === 0 && !allRoles.checked) {
            targetInfo.textContent = 'Select at least one user type.';
        } else if (selectedRoles.length > 0) {
            targetInfo.textContent = `This message will be sent to: ${selectedRoles.join(', ')}.`;
        }
    });
});

document.getElementById('announcementForm').addEventListener('submit', async function(e) {
    e.preventDefault();
    
    if (isGlobalLoading()) return;
    
    const type = document.getElementById('type').value;
    const message = document.getElementById('message').value;
    const allRoles = document.getElementById('allRoles').checked;
    const selectedRoles = allRoles ? ['tourist', 'driver', 'owner'] : 
        Array.from(document.querySelectorAll('input[name="roles"]:checked')).map(cb => cb.value);
    
    if (!message.trim()) {
        showErrorModal('Validation Error', 'Please enter a message');
        return;
    }
    
    if (selectedRoles.length === 0) {
        showErrorModal('Validation Error', 'Please select at least one user type to send to');
        return;
    }
    
    setGlobalLoading(true);
    setButtonLoading('sendBtn', true, 'Sending...');
    
    try {
        const response = await fetch('/announcements/send/', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]')?.value || ''
            },
            body: JSON.stringify({ type, message, roles: selectedRoles })
        });
        
        const result = await response.json();
        
        if (result.success) {
            showSuccessModal('Announcement Sent!', result.message, () => {
                document.getElementById('message').value = '';
            });
        } else {
            showErrorModal('Error', result.error);
        }
    } catch (error) {
        showErrorModal('Network Error', 'Error sending announcement: ' + error.message);
    } finally {
        setGlobalLoading(false);
        setButtonLoading('sendBtn', false);
    }
});
</script>
{% endblock %}