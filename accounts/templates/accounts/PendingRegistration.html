{% load static %}
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Pending Registration</title>
  <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free/css/all.min.css">
</head>
<body class="p-0 md:p-4 ml-5 font-sans text-sm text-gray-800">
  {% include 'base.html' %}

  <div class="flex flex-col md:ml-64 p-4 md:p-6">
    <div class="bg-white rounded-2xl border border-[#531B24] shadow p-4 md:p-6 w-full overflow-hidden">

      <!-- Header -->
      <h2 class="text-2xl font-semibold mb-4">Pending Registration</h2>

      <!-- Top Controls -->
      <div class="flex flex-col sm:flex-row justify-between items-center mb-4 gap-2">
        <div class="relative w-full sm:w-1/3">
          <input type="text" placeholder="Search"
            class="pl-10 pr-4 py-2 w-full h-8 rounded-xl border border-[#531B24] focus:outline-none focus:ring-1 focus:ring-[#531B24]">
          <i class="fas fa-search absolute left-3 top-2.5 text-[#531B24]"></i>
        </div>
        <div class="flex items-center pl-3 pr-3 w-fit h-8 rounded-xl border border-[#531B24] text-gray-700 focus-within:ring-1 focus-within:ring-[#6A2931]">
          <span class="mr-2 whitespace-nowrap text-sm">Sort by:</span>
          <select class="bg-transparent text-sm pr-6 focus:outline-none text-gray-700">
              <option>Newest</option>
              <option>Oldest</option>                          
          </select>
        </div>
      </div>

      <!-- Table -->
      <div class="overflow-x-auto rounded-xl mt-6 text-sm text-center border border-gray-300">
        <table class="min-w-full divide-y divide-gray-200">
          <thead class="h-[50px] bg-gray-100">
            <tr class="text-gray-600">
              <th class="px-4 py-2 w-[150px]">
                <div class="flex items-center justify-center">
                  <span>UserName</span>
                  <i class="fa-solid fa-sort ml-2"></i>
                </div>
              </th>
              <th class="px-4 py-2 w-[120px]">Role</th>
              <th class="px-4 py-2 w-[150px]">Phone Number</th>
              <th class="px-4 py-2 w-[120px]">Status</th>
              <th class="px-4 py-2 w-[200px]">Email</th>
              <th class="px-4 py-2 w-[200px]">Address</th>
              <th class="px-4 py-2 w-[150px]">Action</th>
            </tr>
          </thead>
          <tbody class="divide-y divide-gray-100">
            {% for user in pending_users %}
            <tr class="hover:bg-gray-50" id="registration-{{ user.id }}">
              <td class="px-4 py-3">{{ user.username|default:user.first_name }} {{ user.last_name|default:"" }}</td>
              <td class="px-4 py-3">
                <span class="inline-flex items-center px-3 py-1 rounded-full text-xs font-medium
                  {% if user.role == 'driver' %}bg-blue-100 text-blue-800
                  {% elif user.role == 'owner' %}bg-green-100 text-green-800
                  {% else %}bg-gray-100 text-gray-800{% endif %}">
                  {{ user.role|title }}
                </span>
              </td>
              <td class="px-4 py-3">{{ user.phone|default:"N/A" }}</td>
              <td class="px-4 py-3">
                <span class="inline-flex items-center px-3 py-1 rounded-full text-xs font-medium bg-yellow-100 text-yellow-800">
                  {{ user.status|title }}
                </span>
              </td>
              <td class="px-4 py-3">{{ user.email }}</td>
              <td class="px-4 py-3">{{ user.address|default:"N/A" }}</td>
              <td class="px-4 py-3">
                <div class="flex items-center justify-center space-x-2">
                  <button onclick="openDetailsModal(this)"
                          class="text-blue-500 hover:text-blue-700 details-btn"
                          title="View Application Details"
                          data-id="{{ user.id }}"
                          data-firstname="{{ user.first_name|default:'' }}"
                          data-lastname="{{ user.last_name|default:'' }}"
                          data-username="{{ user.username|default:user.first_name }} {{ user.last_name|default:'' }}"
                          data-role="{{ user.role|default:'' }}"
                          data-email="{{ user.email|default:'' }}"
                          data-phone="{{ user.phone|default:'N/A' }}"
                          data-address="{{ user.address|default:'N/A' }}"
                          data-status="{{ user.status|default:'pending' }}"
                          data-createdat="{{ user.created_at|default:'' }}">
                    <i class="fas fa-eye"></i>
                  </button>
                  <button onclick="approveRegistration('{{ user.id }}', '{{ user.email }}')" 
                          class="text-green-500 hover:text-green-700 approve-btn prevent-multiple-clicks" 
                          data-prevent-multiple
                          title="Approve Registration">
                    <span class="btn-text"><i class="fas fa-check-circle"></i></span>
                    <span class="btn-loading hidden"><i class="fas fa-spinner fa-spin"></i></span>
                  </button>
                  <button onclick="rejectRegistration('{{ user.id }}', '{{ user.email }}')" 
                          class="text-red-500 hover:text-red-700 reject-btn prevent-multiple-clicks"
                          data-prevent-multiple
                          title="Reject Registration">
                    <span class="btn-text"><i class="fas fa-times-circle"></i></span>
                    <span class="btn-loading hidden"><i class="fas fa-spinner fa-spin"></i></span>
                  </button>
                </div>
              </td>
            </tr>
            {% empty %}
            <tr>
              <td colspan="7" class="text-center text-gray-500 py-4">No pending registrations found.</td>
            </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>

      <!-- Details Modal -->
      <div id="DetailsModal" class="fixed inset-0 bg-gradient-to-br from-black/60 via-black/50 to-black/60 backdrop-blur-sm hidden z-50">
        <div class="relative max-w-2xl w-11/12 mx-auto mt-4 mb-4 h-[80vh]">
          <div class="bg-white/95 backdrop-blur-xl border border-white/20 rounded-3xl p-8 shadow-2xl transform transition-all duration-500 hover:shadow-3xl hover:scale-[1.02] h-100 w-full flex flex-col ml-36" style="box-shadow: 0 25px 60px rgba(0,0,0,.15), 0 8px 25px rgba(0,0,0,.08), inset 0 1px 0 rgba(255,255,255,.9);">
            <!-- Header -->
            <div class="text-center mb-8">
              <div class="flex items-center justify-between mb-0">
                <div class="flex-1"></div>
                <button onclick="closeDetailsModal()" class="w-10 h-10 flex items-center justify-center rounded-full bg-gray-100/80 hover:bg-red-100 text-gray-500 hover:text-red-600 transition-all duration-200 hover:scale-110" aria-label="Close">
                  <i class="fas fa-times text-sm"></i>
                </button>
              </div>
              <div class="mb-4">
                <h3 class="text-3xl font-bold text-gray-900 mb-2 tracking-tight">Application Review</h3>
                <p class="text-gray-600 font-medium">Registration Details</p>
              </div>
              <div class="mx-auto w-20 h-1 bg-gradient-to-r from-[#531B24] via-[#8B2635] to-[#531B24] rounded-full"></div>
            </div>

            <!-- Form Content -->
            <div class="space-y-6 max-h-96 overflow-y-auto pr-2">
              <div class="grid grid-cols-2 gap-6">
                <div class="group">
                  <label class="block text-sm font-semibold text-gray-700 mb-3 flex items-center gap-2">
                    <div class="w-6 h-6 bg-blue-100 rounded-lg flex items-center justify-center group-hover:bg-blue-200 transition-colors">
                      <svg fill="currentColor" viewBox="0 0 24 24" width="14" height="14" class="text-blue-600">
                        <path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm-2 15l-5-5 1.41-1.41L10 14.17l7.59-7.59L19 8l-9 9z"/>
                      </svg>
                    </div>
                    Application ID
                  </label>
                  <input type="text" id="details-id" readonly class="w-full px-4 py-3 bg-gray-50/80 border border-gray-200 rounded-xl text-gray-800 focus:outline-none focus:ring-2 focus:ring-[#531B24]/20 focus:border-[#531B24] transition-all text-sm font-mono">
                </div>
                <div class="group">
                  <label class="block text-sm font-semibold text-gray-700 mb-3 flex items-center gap-2">
                    <div class="w-6 h-6 bg-green-100 rounded-lg flex items-center justify-center group-hover:bg-green-200 transition-colors">
                      <svg fill="currentColor" viewBox="0 0 24 24" width="14" height="14" class="text-green-600">
                        <path d="M19 3h-1V1h-2v2H8V1H6v2H5c-1.11 0-1.99.9-1.99 2L3 19c0 1.1.89 2 2 2h14c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2zm0 16H5V8h14v11zM7 10h5v5H7z"/>
                      </svg>
                    </div>
                    Date Submitted
                  </label>
                  <input type="text" id="details-createdat" readonly class="w-full px-4 py-3 bg-gray-50/80 border border-gray-200 rounded-xl text-gray-800 focus:outline-none focus:ring-2 focus:ring-[#531B24]/20 focus:border-[#531B24] transition-all text-sm">
                </div>
              </div>

              <div class="grid grid-cols-2 gap-4">
                <div>
                  <label class="block text-xs font-bold text-gray-700 mb-1 flex items-center gap-2">
                    <svg fill="currentColor" viewBox="0 0 24 24" width="16" height="16">
                      <path d="M12 2C13.1 2 14 2.9 14 4C14 5.1 13.1 6 12 6C10.9 6 10 5.1 10 4C10 2.9 10.9 2 12 2ZM21 9V7L12 2L3 7V9H21M4 10V20C4 21.1 4.9 22 6 22H18C19.1 22 20 21.1 20 20V10H4Z"/>
                    </svg>
                    First Name
                  </label>
                  <input type="text" id="details-firstname" readonly class="w-full px-0 py-2 border-0 border-b-2 border-gray-300 bg-transparent text-gray-800 focus:outline-none focus:border-red-900 transition-colors text-sm">
                </div>
                <div>
                  <label class="block text-xs font-bold text-gray-700 mb-1 flex items-center gap-2">
                    <svg fill="currentColor" viewBox="0 0 24 24" width="16" height="16">
                      <path d="M12 2C13.1 2 14 2.9 14 4C14 5.1 13.1 6 12 6C10.9 6 10 5.1 10 4C10 2.9 10.9 2 12 2ZM21 9V7L12 2L3 7V9H21M4 10V20C4 21.1 4.9 22 6 22H18C19.1 22 20 21.1 20 20V10H4Z"/>
                    </svg>
                    Last Name
                  </label>
                  <input type="text" id="details-lastname" readonly class="w-full px-0 py-2 border-0 border-b-2 border-gray-300 bg-transparent text-gray-800 focus:outline-none focus:border-red-900 transition-colors text-sm">
                </div>
              </div>

              <div>
                <label class="block text-xs font-bold text-gray-700 mb-1 flex items-center gap-2">
                  <svg fill="currentColor" viewBox="0 0 20 20" width="16" height="16">
                    <path d="M2 5a2 2 0 012-2h12a2 2 0 012 2v1H2V5zM2 8h16v5a2 2 0 01-2 2H4a2 2 0 01-2-2V8zm7 3h2v2H9v-2z" />
                  </svg>
                  Email Address
                </label>
                <input type="text" id="details-email" readonly class="w-full px-0 py-2 border-0 border-b-2 border-gray-300 bg-transparent text-gray-800 focus:outline-none focus:border-red-900 transition-colors text-sm">
              </div>

              <div class="grid grid-cols-2 gap-4">
                <div>
                  <label class="block text-xs font-bold text-gray-700 mb-1 flex items-center gap-2">
                    <svg fill="currentColor" viewBox="0 0 24 24" width="16" height="16">
                      <path d="M6.62,10.79C8.06,13.62 10.38,15.94 13.21,17.38L15.41,15.18C15.69,14.9 16.08,14.82 16.43,14.93C17.55,15.3 18.75,15.5 20,15.5A1,1 0 0,1 21,16.5V20A1,1 0 0,1 20,21A17,17 0 0,1 3,4A1,1 0 0,1 4,3H7.5A1,1 0 0,1 8.5,4C8.5,5.25 8.7,6.45 9.07,7.57C9.18,7.92 9.1,8.31 8.82,8.59L6.62,10.79Z"/>
                    </svg>
                    Phone Number
                  </label>
                  <input type="text" id="details-phone" readonly class="w-full px-0 py-2 border-0 border-b-2 border-gray-300 bg-transparent text-gray-800 focus:outline-none focus:border-red-900 transition-colors text-sm">
                </div>
                <div>
                  <label class="block text-xs font-bold text-gray-700 mb-1 flex items-center gap-2">
                    <svg fill="currentColor" viewBox="0 0 24 24" width="16" height="16">
                      <path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm-2 15l-5-5 1.41-1.41L10 14.17l7.59-7.59L19 8l-9 9z"/>
                    </svg>
                    Role Applied
                  </label>
                  <input type="text" id="details-role" readonly class="w-full px-0 py-2 border-0 border-b-2 border-gray-300 bg-transparent text-gray-800 capitalize focus:outline-none focus:border-red-900 transition-colors text-sm">
                </div>
              </div>

              <div>
                <label class="block text-xs font-bold text-gray-700 mb-1 flex items-center gap-2">
                  <svg fill="currentColor" viewBox="0 0 24 24" width="16" height="16">
                    <path d="M12,11.5A2.5,2.5 0 0,1 9.5,9A2.5,2.5 0 0,1 12,6.5A2.5,2.5 0 0,1 14.5,9A2.5,2.5 0 0,1 12,11.5M12,2A7,7 0 0,0 5,9C5,14.25 12,22 12,22C12,22 19,14.25 19,9A7,7 0 0,0 12,2Z"/>
                  </svg>
                  Address
                </label>
                <input type="text" id="details-address" readonly class="w-full px-0 py-2 border-0 border-b-2 border-gray-300 bg-transparent text-gray-800 focus:outline-none focus:border-red-900 transition-colors text-sm">
              </div>

              <div>
                <label class="block text-xs font-bold text-gray-700 mb-2 flex items-center gap-2">
                  <svg fill="currentColor" viewBox="0 0 24 24" width="16" height="16">
                    <path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm-2 15l-5-5 1.41-1.41L10 14.17l7.59-7.59L19 8l-9 9z"/>
                  </svg>
                  Status
                </label>
                <span id="details-status" class="inline-flex items-center px-3 py-1 rounded-full text-sm font-medium bg-amber-100 text-amber-800 capitalize"></span>
              </div>
            </div>

            <!-- Footer -->
            <div class="mt-1 pt-6 border-t border-gray-200/60">
              <div class="flex justify-end">
                <button onclick="closeDetailsModal()" class="px-6 py-2 bg-gradient-to-r from-[#531B24] to-[#8B2635] text-white rounded-xl font-semibold hover:from-[#6A2931] hover:to-[#A12D42] transition-all duration-300 hover:scale-105 shadow-lg hover:shadow-xl flex items-center gap-2">
                  <i class="fas fa-times text-sm"></i>
                  Close
                </button>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Pagination -->
      <div class="flex justify-between items-center mt-4 text-sm text-gray-600">
        <p>
          Showing {{ pending_users|length }} entr{{ pending_users|length|pluralize:'y,ies' }}
        </p>
      </div>
    </div>
  </div>

  <script src="{% static 'js/sidebar.js' %}"></script>
  
  <script>
    // Function to approve a registration
    async function approveRegistration(registrationId, email) {
      if (isGlobalLoading()) return;
      
      showConfirmModal(`Are you sure you want to approve the registration for ${email}?\n\nThis will:\n• Create user account\n• Generate password if needed\n• Send email with credentials`, async function() {
        setGlobalLoading(true);
        const approveBtn = document.querySelector(`button[onclick="approveRegistration('${registrationId}', '${email}')"]`);
        setButtonLoading(approveBtn.id || 'approve-' + registrationId, true, 'Processing...');

      try {
        const response = await fetch('/accounts/api/approve-registration/', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': getCookie('csrftoken')
          },
          credentials: 'same-origin',
          body: JSON.stringify({
            registration_id: registrationId,
            approved_by: 'admin'
          })
        });

        const result = await response.json();

        if (result.success) {
          // Remove the row from the table
          const row = document.getElementById(`registration-${registrationId}`);
          if (row) {
            row.style.backgroundColor = '#dcfce7';
            row.style.transition = 'all 0.3s ease';
            setTimeout(() => {
              row.remove();
              let message = 'Registration approved successfully!';
              if (result.password_generated) {
                message += ' Password generated and emailed to user.';
              } else {
                message += ' User can login with their provided password.';
              }
              showSuccessModal('Registration Approved', message);
            }, 300);
          }
        } else {
          showErrorModal('Approval Failed', result.error);
        }
      } catch (error) {
        console.error('Error approving registration:', error);
        showErrorModal('Network Error', 'An error occurred while approving the registration.');
      } finally {
        setGlobalLoading(false);
        setButtonLoading(approveBtn.id || 'approve-' + registrationId, false);
      }
      });
    }

    // Function to reject a registration
    async function rejectRegistration(registrationId, email) {
      if (isGlobalLoading()) return;
      
      const reason = prompt(`Please provide a reason for rejecting ${email}'s registration:`);
      if (!reason || reason.trim() === '') {
        return;
      }
      
      setGlobalLoading(true);
      const rejectBtn = document.querySelector(`button[onclick="rejectRegistration('${registrationId}', '${email}')"]`);
      setButtonLoading(rejectBtn.id || 'reject-' + registrationId, true, 'Processing...');

      try {
        const response = await fetch('/accounts/api/reject-registration/', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': getCookie('csrftoken')
          },
          credentials: 'same-origin',
          body: JSON.stringify({
            registration_id: registrationId,
            rejected_by: 'admin',
            reason: reason.trim()
          })
        });

        const result = await response.json();

        if (result.success) {
          // Remove the row from the table
          const row = document.getElementById(`registration-${registrationId}`);
          if (row) {
            row.style.backgroundColor = '#fef2f2';
            row.style.transition = 'all 0.3s ease';
            setTimeout(() => {
              row.remove();
              showSuccessModal('Registration Rejected', 'Registration rejected successfully!');
            }, 300);
          }
        } else {
          showErrorModal('Rejection Failed', result.error);
        }
      } catch (error) {
        console.error('Error rejecting registration:', error);
        showErrorModal('Network Error', 'An error occurred while rejecting the registration.');
      } finally {
        setGlobalLoading(false);
        setButtonLoading(rejectBtn.id || 'reject-' + registrationId, false);
      }
    }

    // Helper function to get CSRF token
    function getCookie(name) {
      let cookieValue = null;
      if (document.cookie && document.cookie !== '') {
        const cookies = document.cookie.split(';');
        for (let i = 0; i < cookies.length; i++) {
          const cookie = cookies[i].trim();
          if (cookie.substring(0, name.length + 1) === (name + '=')) {
            cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
            break;
          }
        }
      }
      return cookieValue;
    }



    // Details Modal logic
    function openDetailsModal(btn) {
      const id = btn.getAttribute('data-id') || '';
      const first = btn.getAttribute('data-firstname') || '';
      const last = btn.getAttribute('data-lastname') || '';
      const email = btn.getAttribute('data-email') || '';
      const role = btn.getAttribute('data-role') || '';
      const status = btn.getAttribute('data-status') || '';
      const phone = btn.getAttribute('data-phone') || 'N/A';
      const address = btn.getAttribute('data-address') || 'N/A';
      const createdAt = btn.getAttribute('data-createdat') || '';

      document.getElementById('details-id').value = id;
      document.getElementById('details-firstname').value = first;
      document.getElementById('details-lastname').value = last;
      document.getElementById('details-email').value = email;
      document.getElementById('details-role').value = role;
      document.getElementById('details-status').textContent = status.charAt(0).toUpperCase() + status.slice(1);
      document.getElementById('details-phone').value = phone;
      document.getElementById('details-address').value = address;
      document.getElementById('details-createdat').value = createdAt;

      document.getElementById('DetailsModal').classList.remove('hidden');
    }

    function closeDetailsModal() {
      document.getElementById('DetailsModal').classList.add('hidden');
    }

    // Close on ESC
    document.addEventListener('keydown', function(e) {
      if (e.key === 'Escape') {
        const modal = document.getElementById('DetailsModal');
        if (modal && !modal.classList.contains('hidden')) {
          closeDetailsModal();
        }
      }
    });

    // Search functionality
    const searchInput = document.querySelector('input[type="text"]');
    if (searchInput) {
      searchInput.addEventListener('input', function(e) {
        const searchTerm = e.target.value.toLowerCase();
        const rows = document.querySelectorAll('tbody tr');
        
        rows.forEach(row => {
          const text = row.textContent.toLowerCase();
          row.style.display = text.includes(searchTerm) ? '' : 'none';
        });
      });
    }
  </script>
</body>
</html>
