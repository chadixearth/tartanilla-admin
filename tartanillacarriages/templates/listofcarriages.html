{% load static %}
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Tartanilla Carriages</title>
  <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free/css/all.min.css">
</head>
<body class="p-0 md:p-6 ml-5 bg-gray-50" data-owner-specific="{{ is_owner_specific }}" data-owner-id="{{ owner.id|default:'' }}" data-owner-name="{{ owner.name|default:'' }}">

  <!-- Sidebar -->
  {% include 'base.html' %}

  <div class="flex flex-col md:ml-64 p-4 md:p-6 border border-[#531B24] rounded-2xl bg-white">

    <!-- Header -->
    <div class="flex flex-col md:flex-row md:justify-between md:items-center mb-6">
      <div class="flex gap-2 mt-4 md:mt-0">
        <button onclick="openCreateModal()" class="bg-[#531B24] text-white px-4 py-2 rounded-xl hover:bg-[#6A2931] flex items-center">
            <i class="fas fa-plus mr-2"></i> Add Carriage
          </button>
        <div class="relative">
          <input type="text" id="searchInput" placeholder="Search" 
          class="pl-10 pr-4 py-2 w-full h-8 rounded-xl border border-[#531B24] focus:outline-none focus:ring-1 focus:ring-[#531B24]">
          <i class="fas fa-search absolute left-3 top-2.5 text-[#531B24]"></i>
        </div>
        <select id="statusFilter" class="pl-3 pr-8 h-8 rounded-xl border border-[#531B24] text-gray-700 focus:outline-none focus:ring-1 focus:ring-[#6A2931]">
          <option value="">All Status</option>
          <option value="available">Available</option>
          <option value="under_maintenance">Under Maintenance</option>
          <option value="in_use">In Use</option>
          <option value="unavailable">Unavailable</option>
        </select>
        <select id="eligibilityFilter" class="pl-3 pr-8 h-8 rounded-xl border border-[#531B24] text-gray-700 focus:outline-none focus:ring-1 focus:ring-[#6A2931]">
          <option value="">All Eligibility</option>
          <option value="eligible">Tour Eligible</option>
          <option value="suspended">Suspended</option>
        </select>
      </div>
    </div>

    <!-- Carriages Table -->
    <div class="overflow-x-auto">
      <table class="min-w-full bg-white border border-gray-300 rounded-lg">
        <thead class="bg-[#531B24] text-white">
          <tr>
            <th class="px-4 py-3 text-left">Plate Number</th>
            <th class="px-4 py-3 text-left">Status</th>
            <th class="px-4 py-3 text-left">Capacity</th>
            <th class="px-4 py-3 text-left">Owner</th>
            <th class="px-4 py-3 text-left">Driver</th>
            <th class="px-4 py-3 text-left">Eligibility</th>
            <th class="px-4 py-3 text-left">Actions</th>
          </tr>
        </thead>
        <tbody id="carriagesTableBody">
          {% for carriage in carriages %}
          <tr class="border-b hover:bg-gray-50" data-carriage-id="{{ carriage.id }}">
            <td class="px-4 py-3">{{ carriage.plate_number }}</td>
            <td class="px-4 py-3">
              <span class="px-2 py-1 rounded-full text-xs font-medium
                {% if carriage.status == 'available' %}bg-green-100 text-green-800
                {% elif carriage.status == 'under_maintenance' %}bg-yellow-100 text-yellow-800
                {% elif carriage.status == 'in_use' %}bg-blue-100 text-blue-800
                {% else %}bg-red-100 text-red-800{% endif %}">
                {% if carriage.status == 'under_maintenance' %}Under Maintenance{% elif carriage.status == 'in_use' %}In Use{% else %}{{ carriage.status|title }}{% endif %}
              </span>
            </td>
            <td class="px-4 py-3">{{ carriage.capacity }} persons</td>
            <td class="px-4 py-3">
              {% if carriage.assigned_owner %}
                <div class="flex flex-col">
                  <span class="font-medium text-gray-900">{{ carriage.assigned_owner.name|default:"Unknown" }}</span>
                  <span class="text-sm text-gray-500">{{ carriage.assigned_owner.email|default:"No email" }}</span>
                </div>
              {% elif carriage.assigned_owner_id %}
                <div class="flex flex-col">
                  <span class="font-medium text-gray-900">Owner ID: {{ carriage.assigned_owner_id }}</span>
                  <span class="text-sm text-red-500">Details not loaded</span>
                </div>
              {% else %}
                <span class="text-gray-400 italic">No Owner Assigned</span>
              {% endif %}
            </td>
            <td class="px-4 py-3">
              {% if carriage.assigned_driver %}
                <div class="flex flex-col">
                  <span class="font-medium text-gray-900">{{ carriage.assigned_driver.name|default:"Unknown" }}</span>
                  <span class="text-sm text-gray-500">{{ carriage.assigned_driver.email|default:"No email" }}</span>
                </div>
              {% elif carriage.assigned_driver_id %}
                <div class="flex flex-col">
                  <span class="font-medium text-gray-900">Driver ID: {{ carriage.assigned_driver_id }}</span>
                  <span class="text-sm text-red-500">Details not loaded</span>
                </div>
              {% else %}
                <span class="text-gray-400 italic">Unassigned</span>
              {% endif %}
            </td>
            <td class="px-4 py-3">
              <span class="px-2 py-1 rounded-full text-xs font-medium
                {% if carriage.eligibility == 'eligible' %}bg-green-100 text-green-800
                {% elif carriage.eligibility == 'suspended' %}bg-red-100 text-red-800
                {% else %}bg-gray-100 text-gray-800{% endif %}">
                {% if carriage.eligibility == 'eligible' %}
                  <i class="fas fa-check-circle mr-1"></i>Tour Eligible
                {% elif carriage.eligibility == 'suspended' %}
                  <i class="fas fa-ban mr-1"></i>Suspended
                {% else %}
                  {{ carriage.eligibility|title }}
                {% endif %}
              </span>
            </td>
            <td class="px-4 py-3">
              <div class="flex space-x-2">
                {% if not is_owner_specific %}
                <button onclick="openEditModal('{{ carriage.id }}')" class="text-blue-600 hover:text-blue-800" title="Edit">
                  <i class="fas fa-edit"></i>
                </button>
                <button onclick="toggleEligibility('{{ carriage.id }}', '{{ carriage.eligibility }}')" 
                        class="{% if carriage.eligibility == 'eligible' %}text-orange-600 hover:text-orange-800{% else %}text-green-600 hover:text-green-800{% endif %}" 
                        title="{% if carriage.eligibility == 'eligible' %}Suspend eligibility{% else %}Enable eligibility{% endif %}">
                  {% if carriage.eligibility == 'eligible' %}
                    <i class="fas fa-ban"></i>
                  {% else %}
                    <i class="fas fa-check-circle"></i>
                  {% endif %}
                </button>
                <button onclick="deleteCarriage('{{ carriage.id }}')" class="text-red-600 hover:text-red-800" title="Delete">
                  <i class="fas fa-trash"></i>
                </button>
                {% else %}
                <span class="text-gray-400 text-sm">View Only</span>
                {% endif %}
              </div>
            </td>
          </tr>
          {% empty %}
          <tr>
            <td colspan="7" class="px-4 py-8 text-center text-gray-500">No carriages found.</td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>

    <!-- Footer with pagination -->
    <div class="flex flex-col md:flex-row justify-between items-center mt-6 text-sm text-gray-600 gap-2">
      <p>Showing <span id="carriageCount">{{ carriages|length }}</span> entries</p>
      <div class="flex items-center space-x-1">
        <button class="px-2 py-1 rounded hover:bg-gray-200">&lt;</button>
        <button class="px-2 py-1 rounded bg-[#531B24] text-white">1</button>
        <button class="px-2 py-1 rounded hover:bg-gray-200">2</button>
        <button class="px-2 py-1 rounded hover:bg-gray-200">&gt;</button>
      </div>
    </div>

  </div>

  <!-- Create/Edit Modal -->
  {% if not is_owner_specific %}
  <div id="carriageModal" class="fixed inset-0 bg-black bg-opacity-50 hidden z-50">
    <div class="flex items-center justify-center min-h-screen p-4">
      <div class="bg-white rounded-lg p-6 w-full max-w-md">
        <div class="flex justify-between items-center mb-4">
          <h3 id="modalTitle" class="text-lg font-semibold">Add New Carriage</h3>
          <button onclick="closeModal()" class="text-gray-500 hover:text-gray-700">
            <i class="fas fa-times"></i>
          </button>
        </div>
        
        <form id="carriageForm">
          <input type="hidden" id="carriageId" name="carriageId">
          
          <div class="mb-4">
            <label class="block text-sm font-medium text-gray-700 mb-2">Plate Number</label>
            <input type="text" id="plateNumber" name="plateNumber" required
                   class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-1 focus:ring-[#531B24]">
          </div>
          
          <div class="mb-4">
            <label class="block text-sm font-medium text-gray-700 mb-2">Owner</label>
            <select id="assignedOwner" name="assignedOwner" required
                    class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-1 focus:ring-[#531B24]">
              <option value="">Select Owner</option>
            </select>
          </div>
          
          <div class="mb-4">
            <label class="block text-sm font-medium text-gray-700 mb-2">Capacity</label>
            <input type="number" id="capacity" name="capacity" min="1" max="10" value="4" required
                   class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-1 focus:ring-[#531B24]">
          </div>
          
          <div class="mb-4">
            <label class="block text-sm font-medium text-gray-700 mb-2">Status</label>
            <select id="status" name="status" required
                    class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-1 focus:ring-[#531B24]">
              <option value="available">Available</option>
              <option value="under_maintenance">Under Maintenance</option>
              <option value="in_use">In Use</option>
              <option value="unavailable">Unavailable</option>
            </select>
          </div>
          
          <div class="mb-4">
            <label class="block text-sm font-medium text-gray-700 mb-2">Driver (Optional)</label>
            <select id="assignedDriver" name="assignedDriver"
                    class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-1 focus:ring-[#531B24]">
              <option value="">Unassigned</option>
            </select>
          </div>
          
          <div class="mb-4">
            <label class="block text-sm font-medium text-gray-700 mb-2">Eligibility (Admin Only)</label>
            <select id="eligibility" name="eligibility" required
                    class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-1 focus:ring-[#531B24]">
              <option value="eligible">Eligible</option>
              <option value="suspended">Suspended</option>
            </select>
          </div>
          
          <div class="mb-4">
            <label class="block text-sm font-medium text-gray-700 mb-2">Notes</label>
            <textarea id="notes" name="notes" rows="3"
                      class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-1 focus:ring-[#531B24]"></textarea>
          </div>
          
          <div class="flex justify-end space-x-3">
            <button type="button" onclick="closeModal()" 
                    class="px-4 py-2 text-gray-600 border border-gray-300 rounded-md hover:bg-gray-50">
              Cancel
            </button>
            <button type="submit" 
                    class="px-4 py-2 bg-[#531B24] text-white rounded-md hover:bg-[#6A2931]">
              Save
            </button>
          </div>
        </form>
      </div>
    </div>
  </div>
  {% endif %}

  <script>
    // Get data from HTML attributes
    const isOwnerSpecific = document.body.getAttribute('data-owner-specific') === 'true';
    const ownerId = document.body.getAttribute('data-owner-id');
    const ownerName = document.body.getAttribute('data-owner-name');

    // Load owners and drivers on page load (only for general view)
    document.addEventListener('DOMContentLoaded', function() {
      if (!isOwnerSpecific) {
        loadOwners();
        loadAvailableDrivers();
      }
      // Initialize search and filter
      filterCarriages();
    });

    function openCreateModal() {
      document.getElementById('modalTitle').textContent = 'Add New Carriage';
      document.getElementById('carriageForm').reset();
      document.getElementById('carriageId').value = '';
      document.getElementById('carriageModal').classList.remove('hidden');
    }

    function openEditModal(carriageId) {
      document.getElementById('modalTitle').textContent = 'Edit Carriage';
      document.getElementById('carriageId').value = carriageId;
      
      // Fetch carriage data and populate form using tartanilla API
      fetch(`/api/tartanilla-carriages/${carriageId}/`)
        .then(response => response.json())
        .then(data => {
          if (data.success) {
            const carriage = data.data;
            document.getElementById('plateNumber').value = carriage.plate_number;
            document.getElementById('assignedOwner').value = carriage.assigned_owner_id;
            document.getElementById('capacity').value = carriage.capacity;
            document.getElementById('status').value = carriage.status;
            document.getElementById('assignedDriver').value = carriage.assigned_driver_id || '';
            document.getElementById('eligibility').value = carriage.eligibility;
            document.getElementById('notes').value = carriage.notes || '';
            document.getElementById('carriageModal').classList.remove('hidden');
          } else {
            showErrorModal('Error loading carriage data: ' + data.error);
          }
        })
        .catch(error => {
          console.error('Error:', error);
          showErrorModal('Error loading carriage data');
        });
    }

    function closeModal() {
      document.getElementById('carriageModal').classList.add('hidden');
    }

    function loadOwners() {
      // Use tartanilla API to get owners
      fetch('/api/tartanilla-carriages/get_owners/')
        .then(response => response.json())
        .then(data => {
          if (data.success) {
            const ownerSelect = document.getElementById('assignedOwner');
            ownerSelect.innerHTML = '<option value="">Select Owner</option>';
            data.data.forEach(owner => {
              const option = document.createElement('option');
              option.value = owner.id;
              option.textContent = `${owner.name} (${owner.email})`;
              ownerSelect.appendChild(option);
            });
          }
        })
        .catch(error => console.error('Error loading owners:', error));
    }

    function loadAvailableDrivers() {
      // Use tartanilla API to get available drivers
      fetch('/api/tartanilla-carriages/get_available_drivers/')
        .then(response => response.json())
        .then(data => {
          if (data.success) {
            const driverSelect = document.getElementById('assignedDriver');
            driverSelect.innerHTML = '<option value="">Unassigned</option>';
            data.data.forEach(driver => {
              const option = document.createElement('option');
              option.value = driver.id;
              option.textContent = driver.name;
              driverSelect.appendChild(option);
            });
          }
        })
        .catch(error => console.error('Error loading drivers:', error));
    }

    document.getElementById('carriageForm').addEventListener('submit', function(e) {
      e.preventDefault();
      
      const carriageId = document.getElementById('carriageId').value;
      const formData = {
        plate_number: document.getElementById('plateNumber').value,
        assigned_owner_id: document.getElementById('assignedOwner').value,
        capacity: parseInt(document.getElementById('capacity').value),
        status: document.getElementById('status').value,
        assigned_driver_id: document.getElementById('assignedDriver').value || null,
        eligibility: document.getElementById('eligibility').value,
        notes: document.getElementById('notes').value
      };

      // Use tartanilla API endpoints
      const url = carriageId ? `/api/tartanilla-carriages/${carriageId}/` : '/api/tartanilla-carriages/';
      const method = carriageId ? 'PUT' : 'POST';

      fetch(url, {
        method: method,
        headers: {
          'Content-Type': 'application/json',
          'X-CSRFToken': getCookie('csrftoken')
        },
        body: JSON.stringify(formData)
      })
      .then(response => response.json())
      .then(data => {
        if (data.success) {
          showSuccessModal(carriageId ? 'Carriage updated successfully!' : 'Carriage created successfully!');
          closeModal();
          setTimeout(() => location.reload(), 1500); // Refresh to show updated data
        } else {
          showErrorModal('Error: ' + data.error);
        }
      })
      .catch(error => {
        console.error('Error:', error);
        showErrorModal('Error saving carriage');
      });
    });

    function deleteCarriage(carriageId) {
      showConfirmModal('Are you sure you want to delete this carriage?', () => {
        // Use tartanilla API for deletion
        fetch(`/api/tartanilla-carriages/${carriageId}/`, {
          method: 'DELETE',
          headers: {
            'X-CSRFToken': getCookie('csrftoken')
          }
        })
        .then(response => response.json())
        .then(data => {
          if (data.success) {
            showSuccessModal('Carriage deleted successfully!');
            setTimeout(() => location.reload(), 1500);
          } else {
            showErrorModal('Error: ' + data.error);
          }
        })
        .catch(error => {
          console.error('Error:', error);
          showErrorModal('Error deleting carriage');
        });
      });
    }

    function toggleEligibility(carriageId, currentEligibility) {
      const newEligibility = currentEligibility === 'eligible' ? 'suspended' : 'eligible';
      const action = newEligibility === 'eligible' ? 'enable' : 'suspend';
      
      showConfirmModal(`Are you sure you want to ${action} tour package eligibility for this carriage?`, () => {
        fetch(`/api/tartanilla-carriages/${carriageId}/`, {
          method: 'PUT',
          headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': getCookie('csrftoken')
          },
          body: JSON.stringify({ eligibility: newEligibility })
        })
        .then(response => response.json())
        .then(data => {
          if (data.success) {
            showSuccessModal(`Carriage eligibility ${action}d successfully!`);
            setTimeout(() => location.reload(), 1500);
          } else {
            showErrorModal('Error: ' + data.error);
          }
        })
        .catch(error => {
          console.error('Error:', error);
          showErrorModal('Error updating eligibility');
        });
      });
    }

    function getCookie(name) {
      let cookieValue = null;
      if (document.cookie && document.cookie !== '') {
        const cookies = document.cookie.split(';');
        for (let i = 0; i < cookies.length; i++) {
          const cookie = cookies[i].trim();
          if (cookie.substring(0, name.length + 1) === (name + '=')) {
            cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
            break;
          }
        }
      }
      return cookieValue;
    }

    // Search and filter functionality
    document.getElementById('searchInput').addEventListener('input', function() {
      filterCarriages();
    });

    document.getElementById('statusFilter').addEventListener('change', function() {
      filterCarriages();
    });

    document.getElementById('eligibilityFilter').addEventListener('change', function() {
      filterCarriages();
    });

    function filterCarriages() {
      const searchTerm = document.getElementById('searchInput').value.toLowerCase();
      const statusFilter = document.getElementById('statusFilter').value;
      const eligibilityFilter = document.getElementById('eligibilityFilter').value;
      const rows = document.querySelectorAll('#carriagesTableBody tr');
      let visibleCount = 0;

      rows.forEach(row => {
        if (row.cells.length < 6) return; // Skip empty rows
        
        const plateNumber = row.cells[0].textContent.toLowerCase();
        const status = row.cells[1].textContent.toLowerCase();
        const eligibility = row.cells[5].textContent.toLowerCase();
        
        const matchesSearch = plateNumber.includes(searchTerm);
        const matchesStatus = !statusFilter || status.includes(statusFilter.replace('_', ' '));
        const matchesEligibility = !eligibilityFilter || eligibility.includes(eligibilityFilter);
        
        if (matchesSearch && matchesStatus && matchesEligibility) {
          row.style.display = '';
          visibleCount++;
        } else {
          row.style.display = 'none';
        }
      });

      document.getElementById('carriageCount').textContent = visibleCount;
    }
  </script>
</body>
</html>
